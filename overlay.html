<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Tracking Overlay</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: transparent;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .person-circle {
            position: absolute;
            border: 3px solid #00ff00;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.1s ease-out;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5),
                        0 0 20px rgba(0, 255, 0, 0.3),
                        inset 0 0 10px rgba(0, 255, 0, 0.1);
        }

        .person-label {
            position: absolute;
            transform: translate(-50%, -100%);
            color: #00ff00;
            font-family: 'Arial', sans-serif;
            font-size: 14px;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.8),
                         0 0 10px rgba(0, 255, 0, 0.5);
            white-space: nowrap;
            padding: 2px 8px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            transition: all 0.1s ease-out;
        }

        .face-snapshot {
            position: fixed;
            width: 250px;
            height: 250px;
            border: 3px solid #00ff00;
            border-radius: 50%;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.5);
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5),
                        0 0 30px rgba(0, 255, 0, 0.3);
            z-index: 1000;
            transition: all 0.3s ease-out;
        }

        .face-snapshot img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <div id="snapshots-container"></div>
    <div id="overlay"></div>

    <script>
        const WS_URL = 'ws://localhost:8765';
        const overlay = document.getElementById('overlay');
        const snapshotsContainer = document.getElementById('snapshots-container');

        let ws = null;
        let personElements = new Map();
        let snapshotElements = new Map();
        let reconnectTimeout = null;

        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) return;

            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                console.log('WebSocket connected');
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');

                // Clear all circles on disconnect
                personElements.forEach((el) => {
                    el.circle.remove();
                    el.label.remove();
                });
                personElements.clear();

                // Reconnect after 2 seconds
                reconnectTimeout = setTimeout(connect, 2000);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'tracking') {
                        updateOverlay(data);
                    } else if (data.type === 'face_snapshots') {
                        updateFaceSnapshots(data);
                    }
                } catch (e) {
                    console.error('Error parsing message:', e);
                }
            };
        }

        function updateOverlay(data) {
            const persons = data.persons || [];
            const currentIds = new Set(persons.map(p => String(p.id)));

            // Remove elements for persons no longer tracked
            const toDelete = [];
            personElements.forEach((el, id) => {
                if (!currentIds.has(id)) {
                    el.circle.remove();
                    el.label.remove();
                    toDelete.push(id);
                }
            });
            toDelete.forEach(id => personElements.delete(id));

            // Update or create elements for each person
            persons.forEach(person => {
                const personId = String(person.id);
                let el = personElements.get(personId);

                if (!el) {
                    // Create new elements
                    const circle = document.createElement('div');
                    circle.className = 'person-circle';
                    circle.dataset.personId = personId;

                    const label = document.createElement('div');
                    label.className = 'person-label';
                    label.dataset.personId = personId;

                    overlay.appendChild(circle);
                    overlay.appendChild(label);

                    el = { circle, label };
                    personElements.set(personId, el);
                }

                // Calculate position and size in viewport coordinates
                const viewWidth = window.innerWidth;
                const viewHeight = window.innerHeight;

                const cx = person.center.x * viewWidth;
                const cy = person.center.y * viewHeight;

                // Calculate bbox dimensions
                const bboxWidth = person.bbox.width * viewWidth;
                const bboxHeight = person.bbox.height * viewHeight;
                // Circle that circumscribes the face bbox (diameter = diagonal) + 20% padding
                const diameter = Math.sqrt(bboxWidth * bboxWidth + bboxHeight * bboxHeight) * 1.2;

                // Update circle position and size
                el.circle.style.left = `${cx}px`;
                el.circle.style.top = `${cy}px`;
                el.circle.style.width = `${diameter}px`;
                el.circle.style.height = `${diameter}px`;

                // Update label position
                el.label.style.left = `${cx}px`;
                el.label.style.top = `${cy - diameter / 2 - 5}px`;
                el.label.textContent = `ID: ${person.id}`;
            });

        }

        function calculateSnapshotPosition(position) {
            const SNAPSHOT_SIZE = 250; // px
            const MARGIN = 10; // px from edge
            const LEVEL_SPACING = 280; // px vertical spacing between levels

            let top, left, right;

            // Calculate vertical position based on level
            // Level 0 = center, Level 1 = below center, Level 2 = further below, etc.
            const centerY = window.innerHeight / 2;
            top = centerY - (SNAPSHOT_SIZE / 2) + (position.level * LEVEL_SPACING);

            // Calculate horizontal position based on side
            if (position.side === 'left') {
                left = MARGIN;
                right = 'auto';
            } else {
                left = 'auto';
                right = MARGIN;
            }

            return { top, left, right };
        }

        function updateFaceSnapshots(data) {
            if (!data.snapshots || data.snapshots.length === 0) {
                return;
            }

            const currentIds = new Set(data.snapshots.map(s => String(s.track_id)));

            // Remove snapshots that are no longer present
            const toDelete = [];
            snapshotElements.forEach((el, id) => {
                if (!currentIds.has(id)) {
                    el.remove();
                    toDelete.push(id);
                }
            });
            toDelete.forEach(id => snapshotElements.delete(id));

            // Update or create snapshots
            data.snapshots.forEach(snapshot => {
                const trackId = String(snapshot.track_id);
                let snapshotEl = snapshotElements.get(trackId);

                if (!snapshotEl) {
                    // Create new snapshot element
                    snapshotEl = document.createElement('div');
                    snapshotEl.className = 'face-snapshot';
                    const img = document.createElement('img');
                    img.alt = `Face ${trackId}`;
                    snapshotEl.appendChild(img);
                    snapshotsContainer.appendChild(snapshotEl);
                    snapshotElements.set(trackId, snapshotEl);
                }

                // Update image
                const img = snapshotEl.querySelector('img');
                img.src = snapshot.image;

                // Calculate and apply position
                const pos = calculateSnapshotPosition(snapshot.position);
                snapshotEl.style.top = `${pos.top}px`;
                snapshotEl.style.left = pos.left === 'auto' ? 'auto' : `${pos.left}px`;
                snapshotEl.style.right = pos.right === 'auto' ? 'auto' : `${pos.right}px`;
            });
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            // Elements will be repositioned on next update
        });

        // Start connection
        connect();
    </script>
</body>
</html>
